# Custom Authentication Email Setup

This guide explains how to use Microsoft Graph API to send authentication emails from `maintenance@greatlakesg.com` instead of using Supabase's built-in email system.

## Overview

Instead of using Supabase's default email templates (sent from noreply@supabase.io), we send custom branded emails from your organization's email address using Microsoft Graph API.

## Benefits

- **Branded emails** from your domain (maintenance@greatlakesg.com)
- **Better deliverability** - emails from your domain are less likely to be marked as spam
- **Custom templates** with your branding and styling
- **Unified email system** - all emails come from the same source

## Setup Steps

### 1. Disable Supabase Built-in Emails

In Supabase Dashboard:
1. Go to **Authentication** â†’ **Email Templates**
2. Toggle OFF **"Enable email confirmations"**
3. Toggle OFF **"Enable email change confirmations"** 
4. Save changes

This prevents duplicate emails being sent.

### 2. Deploy the Custom Email Function

Deploy the send-auth-email edge function:

```bash
cd /path/to/your/project
supabase functions deploy send-auth-email
```

### 3. Set Environment Variables

The function uses the same Microsoft Graph credentials as your other email functions:

```bash
# These should already be set if you have email integration working
supabase secrets set MICROSOFT_TENANT_ID="your-tenant-id"
supabase secrets set MICROSOFT_CLIENT_ID="your-client-id"
supabase secrets set MICROSOFT_CLIENT_SECRET="your-client-secret"

# Optional: Set your public site URL
supabase secrets set PUBLIC_SITE_URL="https://www.glgassets.app"
```

### 4. Update Email Permissions

Ensure the Microsoft Graph app has these permissions:
- `Mail.Send` - to send emails
- `User.Read` - to read user information

## How It Works

### Sign Up Flow

1. User fills out registration form
2. Supabase creates the user account (with built-in emails disabled)
3. Our custom function sends a branded confirmation email from maintenance@greatlakesg.com
4. User clicks confirmation link
5. Account is activated

### Password Reset Flow

Update the password reset to use custom email:

```javascript
const handlePasswordReset = async (email) => {
  // Request password reset
  const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: `${window.location.origin}/reset-password`,
  });

  if (!error) {
    // Send custom email
    await supabase.functions.invoke('send-auth-email', {
      body: {
        type: 'reset',
        email: email,
        data: {
          confirmation_url: data?.reset_password_url
        }
      }
    });
  }
};
```

## Email Templates

The custom email function includes professional HTML templates for:

### Signup Confirmation
- Welcome message with user's name
- Clear call-to-action button
- Confirmation link
- Expiration notice (24 hours)

### Password Reset
- Security-focused messaging
- Reset button
- Link expiration (1 hour)
- Warning if not requested

## Testing

### Test Signup Email
1. Create a test account through the registration page
2. Check inbox for email from maintenance@greatlakesg.com
3. Verify styling and links work correctly

### Test Password Reset
1. Go to login page
2. Click "Forgot Password"
3. Enter email address
4. Check for reset email from maintenance@greatlakesg.com

## Troubleshooting

### Emails Not Sending

1. Check edge function logs:
   ```bash
   supabase functions logs send-auth-email
   ```

2. Verify Microsoft Graph credentials are set correctly

3. Check Microsoft Graph API permissions

### Users Not Receiving Emails

1. Check spam/junk folders
2. Verify email address is correct
3. Check email queue table for errors:
   ```sql
   SELECT * FROM email_queue 
   WHERE template_type LIKE 'auth_%' 
   ORDER BY created_at DESC;
   ```

### Duplicate Emails

If users receive both Supabase and custom emails:
1. Ensure Supabase email confirmations are disabled in Dashboard
2. Check that you're not calling both systems

## Customization

### Change From Address

To send from a different address, modify in `send-auth-email/index.ts`:
```typescript
const fromEmail = 'support@greatlakesg.com' // Change this
```

### Modify Templates

Edit the HTML templates in `getEmailTemplate()` function to match your brand:
- Colors
- Logo
- Footer text
- Support contact

### Add More Email Types

Extend the function to handle:
- Email change confirmations
- Magic link logins
- Invite emails

## Security Notes

- Confirmation tokens are generated by Supabase and remain secure
- Emails are sent over Microsoft's secure infrastructure
- No passwords or sensitive data in emails
- Links expire after set time period

## Migration from Supabase Emails

If you have existing users:
1. Deploy custom email function
2. Test with new registrations
3. Disable Supabase emails
4. All new signups will use custom emails
5. Existing users are unaffected

## Support

For issues with:
- **Email sending**: Check Microsoft Graph API logs
- **Authentication**: Check Supabase Auth logs
- **Templates**: Modify the edge function code